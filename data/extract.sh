#!/bin/bash

# Pour les formats de numéros avec "." et non ","
export LC_ALL="en_US.UTF-8"

for i in $@ ; do
    echo -n $i
    lines=$(wc -l $i | sed 's/^\([0-9]*\) .*/\1/')
    echo -n .
    
    combine=$(cat $i \
    | grep " GET /revue/[^ /]\+/[^ /]\+/[^ /]\+/[^ /]\+/[^ /]\+\.\(html\|pdf\)[^ /]*" \
    | sed 's/\(^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\} [0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\) GET \(\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\) .*/\1 \2/' \
    | wc -l)
    echo -n .

    pdf=$(cat $i \
    | grep " GET /revue/[^ /]\+/[^ /]\+/[^ /]\+/[^ /]\+/[^ /]\+\.pdf[^ /]*" \
    | sed 's/\(^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\} [0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\) GET \(\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\) .*/\1 \2/' \
    | wc -l)
    echo -n .

    html=$(cat $i \
    | grep " GET /revue/[^ /]\+/[^ /]\+/[^ /]\+/[^ /]\+/[^ /]\+\.html[^ /]*" \
    | sed 's/\(^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\} [0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\} [0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\) GET \(\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\/[^\ ]*\) .*/\1 \2/' \
    | wc -l)

    printf ": %d fichiers (%d pdf %.2f %%, %d html %.2f %%) sur %d accès : %.2f %% des accès sont aux documents\n" $combine $pdf $(echo "$pdf/$combine*100" | bc -l) $html $(echo "$html/$combine*100" | bc -l) $lines $(echo "$combine/$lines*100" | bc -l)
done
